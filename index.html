<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x402: Quantum Algo Market</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff00; padding: 50px; text-align: center; }
        h1 { font-size: 3rem; text-shadow: 0 0 10px #00ff00; }
        .card { border: 1px solid #333; padding: 30px; display: inline-block; background: #111; border-radius: 10px; width: 400px; }
        button { background: #00ff00; color: black; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.2s; }
        button:hover { background: #ccffcc; box-shadow: 0 0 15px #00ff00; }
        #status { margin-top: 20px; color: #888; font-size: 0.9rem; min-height: 1.2em; word-break: break-all; }
        #result { margin-top: 20px; font-size: 1.5rem; display: none; border: 1px solid #00ff00; padding: 20px; background: #001100; }
        .data-row { margin: 10px 0; }
    </style>
</head>
<body>

    <h1>x402 QUANTUM MARKET</h1>
    
    <div class="card">
        <h3>Bitcoin LSTM Predictor</h3>
        <p>Purchase the next hour's price direction signal generated by our autonomous AI Agent.</p>
        <p style="font-size: 2rem; margin: 20px 0;">Price: 1.0 USDC</p>
        
        <button id="buyBtn" onclick="buySignal()">CONNECT & BUY</button>
        <div id="status">Waiting for connection...</div>
    </div>

    <div id="result">
        <h2>PREDICTION UNLOCKED</h2>
        <div class="data-row" id="signalText">...</div>
        <div class="data-row" id="confText" style="font-size: 0.8rem; color: #aaa;">...</div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000/signal";
        const USDC_ADDRESS_RAW = "0x036CbD53842c5426634e7929541eC2318f3dCF7e"; // Base Sepolia USDC
        const CHAIN_ID_HEX = "0x14a34"; // 84532 in Hex (Base Sepolia)

        const ERC20_ABI = [
            "function transfer(address to, uint amount) returns (bool)",
            "function balanceOf(address owner) view returns (uint)"
        ];

        // --- HELPER: Fixes "Bad Address Checksum" Errors ---
        function sanitizeAddress(addr) {
            if (!addr) return null;
            // Force lowercase first to strip bad checksums, then let ethers re-checksum it
            return ethers.utils.getAddress(addr.toLowerCase());
        }

        async function buySignal() {
            const status = document.getElementById("status");
            const btn = document.getElementById("buyBtn");
            const resultDiv = document.getElementById("result");
            
            // Reset UI
            status.style.color = "#888";
            resultDiv.style.display = "none";

            try {
                // --- 1. Wallet Connection & Network Check ---
                if (!window.ethereum) return alert("Please install Coinbase Wallet or MetaMask!");
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const myAddress = await signer.getAddress();
                
                // Check Network (Base Sepolia)
                const network = await provider.getNetwork();
                if (network.chainId !== 84532) {
                    status.innerText = "Wrong Network! Switching to Base Sepolia...";
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: CHAIN_ID_HEX }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                             status.innerText = "Please add Base Sepolia network to your wallet.";
                             return;
                        }
                        throw switchError;
                    }
                    // Re-instantiate provider after switch
                    const providerNew = new ethers.providers.Web3Provider(window.ethereum);
                }

                status.innerText = "ðŸ”— Connected: " + myAddress.substring(0,6) + "...";
                btn.innerText = "Processing...";

                // --- 2. Initial Handshake (Expect 402) ---
                console.log("Fetching price from API...");
                const resp1 = await fetch(API_URL);
                
                if (resp1.status === 402) {
                    const priceStr = resp1.headers.get("x-402-price");
                    const rawSellerAddress = resp1.headers.get("x-402-address");

                    if (!priceStr || !rawSellerAddress) {
                        throw new Error("Missing headers! Server CORS config might be blocking x-402-address.");
                    }

                    // --- THE FIX: Sanitize BOTH addresses ---
                    const cleanSeller = sanitizeAddress(rawSellerAddress);
                    const cleanUSDC = sanitizeAddress(USDC_ADDRESS_RAW);

                    console.log(`Payment: ${priceStr} USDC to ${cleanSeller}`);

                    // --- 3. Pay on Blockchain ---
                    status.innerText = "Please sign transaction in wallet...";
                    
                    // Initialize contract with the CLEANED address
                    const usdcContract = new ethers.Contract(cleanUSDC, ERC20_ABI, signer);
                    
                    // Parse price safely
                    const amount = ethers.BigNumber.from(priceStr);

                    // Send Transaction to CLEANED seller
                    const tx = await usdcContract.transfer(cleanSeller, amount);
                    status.innerText = "Transaction sent! Waiting for confirmation...";
                    console.log("Tx Hash:", tx.hash);
                    
                    await tx.wait(); // Wait for 1 block confirmation
                    status.innerText = "Payment Confirmed! Fetching Signal...";
                    
                    // --- 4. Retry with Proof ---
                    const resp2 = await fetch(API_URL, {
                        headers: { "Authorization": tx.hash }
                    });
                    
                    const data = await resp2.json();
                    
                    if (data.status === "PAID") {
                        resultDiv.style.display = "block";
                        document.getElementById("signalText").innerHTML = "SIGNAL: <span style='color:white'>" + data.data.signal + "</span>";
                        document.getElementById("confText").innerText = "Confidence Score: " + (data.data.confidence * 100).toFixed(1) + "%";
                        
                        status.innerText = "Transaction Complete.";
                        status.style.color = "#00ff00";
                        btn.innerText = "BUY AGAIN";
                    } else {
                        throw new Error("Server verification failed: " + JSON.stringify(data));
                    }
                } else {
                    status.innerText = "Unexpected Server Response: " + resp1.status;
                }

            } catch (err) {
                console.error(err);
                if (err.code === 4001 || err.code === 'ACTION_REJECTED') {
                    status.innerText = "Transaction rejected by user.";
                } else {
                    // Print the specific reason if available
                    status.innerText = "Error: " + (err.reason || err.message || err);
                }
                status.style.color = "red";
                btn.innerText = "TRY AGAIN";
            }
        }
    </script>
</body>
</html>